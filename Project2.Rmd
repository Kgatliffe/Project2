---
title: "Project 2"
output:
  word_document: default
  html_notebook: default
---

```{r}

library(car)
library(caTools)
library(ggplot2)
library(gridExtra)
library(leaps)
library(MASS)
library(pls)
library(plyr)
library(randomForest)
library(wesanderson)

setwd("/Users/gatliffe/Documents/In Process/ASM Project 2")
Telco <- read.csv('WA_Fn-UseC_-Telco-Customer-Churn.csv')
#str(Telco)


colnames(Telco)[colnames(Telco)=="gender"] <- "Gender"
colnames(Telco)[colnames(Telco)=="tenure"] <- "Tenure"

#Remove ID
Telco <- Telco[-c(1)]

sapply(Telco, function(x) sum(is.na(x)))
#Remove NAs
Telco <- Telco[complete.cases(Telco), ] 
#Fix SeniorCitizen to match other variables
Telco$SeniorCitizen <- as.factor(mapvalues
  (Telco$SeniorCitizen, from=c("0","1"), to=c("No", "Yes")))
#Remove no internet service rows
Telco<- subset(Telco, Telco$OnlineSecurity != "No internet service") 
#Change no phone service to no
Telco$MultipleLines <- as.factor(mapvalues(Telco$MultipleLines, 
    from=c("No phone service"), to=c("No")))

Telco$InternetService<-factor(Telco$InternetService)
Telco$OnlineSecurity<-factor(Telco$OnlineSecurity)
Telco$OnlineBackup <-factor(Telco$OnlineBackup )
Telco$DeviceProtection<-factor(Telco$DeviceProtection)
Telco$TechSupport<-factor(Telco$TechSupport)
Telco$StreamingTV<-factor(Telco$StreamingTV)
Telco$StreamingMovies <-factor(Telco$StreamingMovies)
summary(Telco)
```
 
 Setting Up Train and Test, Train is sample=True
 
```{r echo=FALSE}
set.seed(1420)
Telco$sample = sample.split(Telco$Churn, SplitRatio = .75)
```

Check Correlations on train set only

```{r echo=FALSE}
library(corrplot)
numeric.var <- sapply(Telco, is.numeric) 
trainset = subset(Telco, Telco$sample == TRUE)
cors<-cor(trainset[,numeric.var])  
corrplot(cors)
 Telco$FixedCharges<-NA
for(i in 1:nrow(Telco))
{
 Telco$FixedCharges[i]<-Telco$TotalCharges[i]-(Telco$MonthlyCharges[i]*Telco$Tenure[i]) 
}
numeric.var <- sapply(Telco, is.numeric) 
trainset = subset(Telco, Telco$sample == TRUE)
cors<-cor(trainset[,numeric.var])  
corrplot(cors)
```

TotalCharges has high correlations, dropping in favor of FixedCharges.

```{r echo=FALSE}
Telco <- Telco[-c(19)]
trainset = subset(Telco, Telco$sample == TRUE)
```

Plots

```{r echo=FALSE}
color=wes_palette("Zissou1",n=2)

plot1<-ggplot(data=trainset, aes(x=factor(Gender)))+ggtitle("Gender")+geom_bar(width=0.7, fill=color)+ coord_flip()
plot2<-ggplot(data=trainset, aes(x=factor(SeniorCitizen)))+ggtitle("Senior Citizen")+geom_bar(width=0.7, fill=color)+ coord_flip()  
plot3<-ggplot(data=trainset, aes(x=factor(Partner)))+ ggtitle("Partner")+geom_bar(width=0.7, fill=color)+ coord_flip()
plot4<-ggplot(data=trainset, aes(x=factor(Dependents)))+ ggtitle("Dependents")+geom_bar(width=0.7, fill=color) + coord_flip()    
plot5 <- ggplot(data=trainset, aes(x=PhoneService)) + ggtitle("Phone Service") +geom_bar(width=0.7, fill=color)+ coord_flip()
plot6 <- ggplot(data=trainset, aes(x=MultipleLines)) + ggtitle("Multiple Lines")+geom_bar(width=0.7, fill=color)+ coord_flip()
grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, ncol=2)

plot7 <- ggplot(data=trainset, aes(x=InternetService)) + ggtitle("Internet Service") +geom_bar(width=0.7, fill=color)+ coord_flip()
plot8 <- ggplot(data=trainset, aes(x=OnlineSecurity)) + ggtitle("Online Security") + geom_bar(width=0.7, fill=color)+ coord_flip()
plot9 <- ggplot(trainset, aes(x=OnlineBackup)) + ggtitle("Online Backup")  +geom_bar(width=0.7, fill=color) + coord_flip() 
plot10 <- ggplot(trainset, aes(x=DeviceProtection)) + ggtitle("Device Protection") +geom_bar(width=0.7, fill=color) + coord_flip() 
plot11 <- ggplot(trainset, aes(x=TechSupport)) + ggtitle("Tech Support") +geom_bar(width=0.7, fill=color) + coord_flip() 
plot12 <- ggplot(trainset, aes(x=StreamingTV)) + ggtitle("Streaming TV") +geom_bar(width=0.7, fill=color) + coord_flip() 
grid.arrange(plot7, plot8, plot9, plot10, plot11, plot12, ncol=2)

plot13 <- ggplot(trainset, aes(x=StreamingMovies)) + ggtitle("Streaming Movies")+geom_bar(width=0.7, fill=color) + coord_flip()
color=wes_palette("Zissou1",n=3)
plot14 <- ggplot(trainset, aes(x=Contract)) + ggtitle("Contract") +geom_bar(width=0.7, fill=color) + coord_flip() 
color=wes_palette("Zissou1",n=2)
plot15 <- ggplot(trainset, aes(x=PaperlessBilling)) + ggtitle("Paperless Billing")+geom_bar(width=0.7, fill=color) + coord_flip() 
color=wes_palette("Zissou1",n=4)
plot16 <- ggplot(trainset, aes(x=PaymentMethod)) + ggtitle("Payment Method")+geom_bar(width=0.7, fill=color) + coord_flip() 

trainset$TenureCat<-NA

trainset$TenureCat[trainset$Tenure <= 6] <- "00-06M"
trainset$TenureCat[trainset$Tenure > 6 & trainset$Tenure <= 12] <- "06-12M"
trainset$TenureCat[trainset$Tenure > 12 & trainset$Tenure <= 24] <- "12-24M"
trainset$TenureCat[trainset$Tenure > 24] <- "24+M"
trainset$TenureCat<-factor(trainset$TenureCat)

color=wes_palette("Zissou1",n=4)
plot17 <- ggplot(trainset, aes(x=TenureCat)) + ggtitle("Tenure Group")+geom_bar(width=0.7, fill=color) + coord_flip() 

grid.arrange(plot13, plot14, plot15, plot16,plot17, ncol=2)
```

Dummy Variables for Tenure

```{r eval=FALSE, include=FALSE}
Telco$TenureCat.00.06<-0
Telco$TenureCat.06.12<-0
Telco$TenureCat.12.24<-0

Telco$TenureCat.00.06[Telco$Tenure <= 6] <- 1
Telco$TenureCat.06.12[Telco$Tenure > 6 & Telco$Tenure <= 12] <- 1
Telco$TenureCat.12.24[Telco$Tenure > 12 & Telco$Tenure <= 24] <- 1

Telco <- Telco[-c(5)]
Telco$TenureCat.00.06<-factor(Telco$TenureCat.00.06)
Telco$TenureCat.06.12<-factor(Telco$TenureCat.06.12)
Telco$TenureCat.12.24<-factor(Telco$TenureCat.12.24)
```

Dummies for Payment Method, Contract

```{r echo=FALSE}
Telco$OneYearContract<-0
Telco$TwoYearContract<-0

Telco$BankTransfer<-0
Telco$CreditCard<-0
Telco$ECheck<-0

Telco$OneYearContract[Telco$Contract == "One year"] <- 1
Telco$TwoYearContract[Telco$Contract == "Two year"] <- 1

Telco$BankTransfer[Telco$PaymentMethod == "Bank transfer (automatic)"] <- 1
Telco$CreditCard[Telco$PaymentMethod == "Credit card (automatic)"] <- 1
Telco$ECheck[Telco$PaymentMethod == "Electronic check"] <- 1

Telco$OneYearContract<-factor(Telco$OneYearContract)
Telco$TwoYearContract<-factor(Telco$TwoYearContract)

Telco$BankTransfer<-factor(Telco$BankTransfer)
Telco$CreditCard<-factor(Telco$CreditCard)
Telco$ECheck<-factor(Telco$ECheck)

Telco <- Telco[-c(14,16)]
summary(Telco)
write.csv(Telco, file = 'TelcoF.csv')
```                              

Chi Squared

```{r include=FALSE}
trainset = subset(Telco, Telco$sample == TRUE)

for (i in 1:24)
{  k=i+1
if (i != 15){
  if (i != 17){
  for (j in k:25)
  {
    if (j != 15){
       if (j != 17){
    print(paste( i,"and", j))
    tbl = table(trainset[,i], trainset[,j])
        print(chisq.test(tbl,simulate.p.value = TRUE))
    }
  }
}
}
}
}
```

The chisq show a lot of colinearity.  

Splitting out test. TelcoN is Telco converted to numerical in excel.

```{r echo=FALSE}
Telco<-read.csv('TelcoN.csv')
trainset = subset(Telco, Telco$sample == TRUE)
testset  = subset(Telco, Telco$sample == FALSE)
trainset <-trainset[c(-17)]
trainset <-testset[c(-17)]
summary(Telco)
```

Logistic Model

```{r echo=FALSE}
LogisticModel <- glm(as.factor(Churn) ~ .,family=binomial(link="logit"),data=trainset)
summary(LogisticModel)
anova(LogisticModel, test="Chisq")
```

AIC Selection 

```{r echo=FALSE}
mean_train<-apply(trainset, 2, mean)
var_train<-apply(trainset, 2, var)

train <- t((t(trainset)-mean_train)/sqrt(var_train))
apply(train, 2, mean)
apply(train, 2, var)

dat.train<-data.frame(train, Churn=trainset$Churn)
dat.train<-dat.train[c(-16)]

##	NEED TO APPLY TRAINING MEAN AND STDEV TO STANDARDIZE TEST SET!!  ##
test <- t((t(testset)-mean_train)/sqrt(var_train))
dat.test <- data.frame(test, Churn=testset$Churn)
apply(test, 2, mean)
apply(test, 2, var)

	LogisticModel.int <- glm(as.factor(Churn.1) ~ 1, family=binomial(link="logit"), data=dat.train)
	LogisticModel.full <- glm(as.factor(Churn.1) ~ ., family=binomial(link="logit"),  data=dat.train)
```

Stepwise Selection AIC

```{r echo=FALSE}
stepAIC(LogisticModel.int, direction="both",
             scope=list(lower=LogisticModel.int, upper= LogisticModel.full))
```

Logistic AIC Model

```{r echo=FALSE}
LogisticModelAIC <- glm(as.factor(Churn) ~ TenureCat.00.06 + InternetService + TwoYearContract + OneYearContract + ECheck + PaperlessBilling + TechSupport +      OnlineSecurity + TenureCat.06.12 + PhoneService + MonthlyCharges +      TenureCat.12.24,family=binomial(link="logit"),data=trainset)
summary(LogisticModelAIC)
anova(LogisticModelAIC, test="Chisq")

fitted.resultsLogisticAIC <- predict(LogisticModelAIC,newdata=testset,type='response')
fitted.resultsLogisticAIC <- ifelse(fitted.resultsLogisticAIC > 0.5,1,0)
misClasificErrorLogisticAIC <- mean(fitted.resultsLogisticAIC != testset$Churn)
print(1-misClasificErrorLogisticAIC)
table(testset$Churn, fitted.resultsLogisticAIC > 0.5)
exp(cbind(OR=coef(LogisticModelAIC), confint(LogisticModelAIC)))
```

Stepwise Selection BIC

```{r echo=FALSE}
stepAIC(LogisticModel.int, direction="both", k=log(1378),
             scope=list(lower=LogisticModel.int, upper= LogisticModel.full), criterion = "BIC")
```

Logistic BIC Model

```{r echo=FALSE}
LogisticModelBIC <- glm(as.factor(Churn) ~ TenureCat.00.06 + InternetService + TwoYearContract + OneYearContract + ECheck + PaperlessBilling + TechSupport +      OnlineSecurity,family=binomial(link="logit"),data=trainset)
summary(LogisticModelBIC)
anova(LogisticModelBIC, test="Chisq")

fitted.resultsLogisticBIC <- predict(LogisticModelBIC,newdata=testset,type='response')
fitted.resultsLogisticBIC <- ifelse(fitted.resultsLogisticBIC > 0.5,1,0)
misClasificErrorLogisticBIC <- mean(fitted.resultsLogisticBIC != testset$Churn)
print(1-misClasificErrorLogisticBIC)
table(testset$Churn, fitted.resultsBIC > 0.5)
exp(cbind(OR=coef(LogisticModelBIC), confint(LogisticModelBIC)))
```

Probit Model

```{r echo=FALSE}
ProbitModel <- glm(as.factor(Churn.1) ~ 1, family=binomial(link="probit"),data=dat.train)
summary(ProbitModel)
anova(ProbitModel, test="Chisq")
```

AIC Selection 

```{r echo=FALSE}
ProbitModel.int <- glm(as.factor(Churn.1) ~ 1, family=binomial(link="probit"),data=dat.train)
ProbitModel.full <- glm(as.factor(Churn.1) ~ ., family=binomial(link="probit"),data=dat.train)
```

Stepwise Selection AIC

```{r echo=FALSE}
stepAIC(ProbitModel.int, direction="both",
             scope=list(lower=ProbitModel.int, upper= ProbitModel.full))
```

Probit Model AIC

```{r echo=FALSE}
ProbitModelAIC <- glm(Churn ~ TenureCat.00.06 + InternetService + 
    TwoYearContract + OneYearContract + ECheck + PaperlessBilling + 
    TechSupport + OnlineSecurity + TenureCat.06.12 + StreamingMovies + 
    PhoneService + TenureCat.12.24,family=binomial(link="probit"),data=trainset)
summary(ProbitModelAIC)
anova(ProbitModelAIC, test="Chisq")

fitted.resultsProbitAIC <- predict(ProbitModelAIC,newdata=testset,type='response')
fitted.resultsProbitAIC <- ifelse(fitted.resultsProbitAIC > 0.5,1,0)
misClasificErrorProbitAIC <- mean(fitted.resultsProbitAIC != testset$Churn)
print(1-misClasificErrorProbitAIC)
table(testset$Churn, fitted.resultsProbitAIC > 0.5)
exp(cbind(OR=coef(ProbitModelAIC), confint(ProbitModelAIC)))
```

Stepwise Selection BIC

```{r echo=FALSE}
stepAIC(ProbitModel.int, direction="both", k=log(1378),
             scope=list(lower=ProbitModel.int, upper= ProbitModel.full), criterion = "BIC")
```

Probit BIC

```{r echo=FALSE}
ProbitModelBIC <- glm(as.factor(Churn) ~ TenureCat.00.06 + InternetService + 
    TwoYearContract + OneYearContract + ECheck + PaperlessBilling + 
    TechSupport + OnlineSecurity,family=binomial(link="probit"),data=trainset)
summary(LogisticModelBIC)
anova(ProbitModelBIC, test="Chisq")

fitted.resultsProbitBIC <- predict(ProbitModelBIC,newdata=testset,type='response')
fitted.resultsProbitBIC <- ifelse(fitted.resultsProbitBIC > 0.5,1,0)
misClasificErrorProbitBIC <- mean(fitted.resultsProbitBIC != testset$Churn)
print(1-misClasificErrorProbitBIC)
table(testset$Churn, fitted.resultsProbitBIC > 0.5)
exp(cbind(OR=coef(ProbitModelBIC), confint(ProbitModelBIC)))
```

Loading Factored Data Set for Random Forest

```{r echo=FALSE}
Telco<-read.csv('TelcoF.csv')
trainset = subset(Telco, Telco$sample == TRUE)
testset  = subset(Telco, Telco$sample == FALSE)
trainset <-trainset[c(-18)]
trainset <-testset[c(-18)]
summary(Telco)
```

Random Forest

```{r echo=FALSE}

RandomForestMod <- randomForest(Churn ~., data = trainset)
print(RandomForestMod)
RandomForestPredict <- predict(RandomForestMod, testset)
plot(RandomForestMod)
varImpPlot(RandomForestMod, sort=T, n.var = 10, main = 'Top 10 Feature Importance')
RandomForestTune <- tuneRF(trainset[, -16], trainset[, 16], stepFactor = 0.5, plot = TRUE, ntreeTry = 200, trace = TRUE, improve = 0.05)
```

Refit
```{r echo=FALSE}
RandomForestMod.2 <- randomForest(Churn ~., data = trainset, ntree = 200, mtry = 2, importance = TRUE, proximity = TRUE)
print(RandomForestMod.2)
pred_rf_new <- predict(RandomForestMod.2, testset)
testset$Churn<-as.factor(testset$Churn)

varImpPlot(RandomForestMod.2, sort=T, n.var = 10, main = 'Top 10 Feature Importance')
```

Compare
```{r}
print ("Logistic AIC")
print("LogisticModelAIC")
print(1-misClasificErrorLogisticAIC)
table(testset$Churn, fitted.resultsLogisticAIC > 0.5)
exp(cbind(OR=coef(LogisticModelAIC), confint(LogisticModelAIC)))
print ("Logistic BIC")
print("LogisticModelBIC")
print(1-misClasificErrorLogisticBIC)
table(testset$Churn, fitted.resultsLogisticBIC > 0.5)
exp(cbind(OR=coef(LogisticModelBIC), confint(LogisticModelBIC)))
print ("Probit AIC")
print("ProbitModelAIC")
print(1-misClasificErrorProbitAIC)
table(testset$Churn, fitted.resultsProbitAIC > 0.5)
exp(cbind(OR=coef(ProbitModelAIC), confint(ProbitModelAIC)))
print ("Probit BIC")
print("ProbitModelBIC")
print(1-misClasificErrorProbitBIC)
table(testset$Churn, fitted.resultsProbitBIC > 0.5)
exp(cbind(OR=coef(ProbitModelBIC), confint(ProbitModelBIC)))

```

